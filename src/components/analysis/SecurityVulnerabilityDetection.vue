<template>
  <div class="bg-gradient-to-br from-white/[0.07] to-white/[0.03] backdrop-blur-xl rounded-2xl border border-white/10 p-6">
    <h3 class="text-xl font-semibold text-white mb-4">安全漏洞检测</h3>
    
    <!-- 漏洞统计 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white/5 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">总漏洞数</div>
        <div class="text-2xl font-bold text-white">
          {{ statistics.total }}
        </div>
      </div>
      
      <div class="bg-white/5 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">高危漏洞</div>
        <div class="text-2xl font-bold text-red-400">
          {{ statistics.high }}
        </div>
      </div>
      
      <div class="bg-white/5 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">中危漏洞</div>
        <div class="text-2xl font-bold text-yellow-400">
          {{ statistics.medium }}
        </div>
      </div>
      
      <div class="bg-white/5 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">低危漏洞</div>
        <div class="text-2xl font-bold text-blue-400">
          {{ statistics.low }}
        </div>
      </div>
    </div>

    <!-- 风险等级分布 -->
    <div class="bg-white/5 rounded-lg p-4 mb-6">
      <h4 class="text-white font-medium mb-3">风险等级分布</h4>
      <div class="flex items-center gap-2">
        <div class="flex-1 bg-gray-700 rounded-full h-4 overflow-hidden">
          <div class="h-full bg-red-500" :style="{ width: `${getRiskPercentage('high')}%` }"></div>
        </div>
        <span class="text-red-400 text-sm">{{ getRiskPercentage('high') }}%</span>
      </div>
      <div class="flex items-center gap-2 mt-2">
        <div class="flex-1 bg-gray-700 rounded-full h-4 overflow-hidden">
          <div class="h-full bg-yellow-500" :style="{ width: `${getRiskPercentage('medium')}%` }"></div>
        </div>
        <span class="text-yellow-400 text-sm">{{ getRiskPercentage('medium') }}%</span>
      </div>
      <div class="flex items-center gap-2 mt-2">
        <div class="flex-1 bg-gray-700 rounded-full h-4 overflow-hidden">
          <div class="h-full bg-blue-500" :style="{ width: `${getRiskPercentage('low')}%` }"></div>
        </div>
        <span class="text-blue-400 text-sm">{{ getRiskPercentage('low') }}%</span>
      </div>
    </div>

    <!-- 漏洞列表 -->
    <div class="space-y-4">
      <div v-for="(vulnerability, index) in vulnerabilities" :key="index" 
           class="bg-white/5 rounded-lg p-4">
        <div class="flex items-start">
          <div :class="getVulnerabilitySeverityColor(vulnerability.severity)" 
               class="w-2 h-2 rounded-full mt-2 mr-3"></div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <h4 class="text-white font-medium">{{ vulnerability.title }}</h4>
              <span :class="getVulnerabilitySeverityTextColor(vulnerability.severity)" 
                    class="text-sm font-medium">
                {{ vulnerability.severity.toUpperCase() }}
              </span>
            </div>
            <p class="text-gray-400 text-sm mt-1">{{ vulnerability.description }}</p>
            <div class="mt-3 space-y-2">
              <div class="text-sm text-gray-500">
                位置: {{ vulnerability.location }}
              </div>
              <div class="text-sm text-gray-500">
                CWE: {{ vulnerability.cwe }}
              </div>
              <div class="text-sm text-gray-500">
                修复建议: {{ vulnerability.recommendation }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'

const statistics = ref({
  total: 0,
  high: 0,
  medium: 0,
  low: 0
})

const vulnerabilities = ref([])

// 计算风险等级百分比
const getRiskPercentage = (severity) => {
  const total = statistics.value.total
  if (total === 0) return 0
  const count = statistics.value[severity]
  return Math.round((count / total) * 100)
}

// 获取漏洞严重程度对应的颜色
const getVulnerabilitySeverityColor = (severity) => {
  const colors = {
    high: 'bg-red-500',
    medium: 'bg-yellow-500',
    low: 'bg-blue-500'
  }
  return colors[severity] || 'bg-gray-500'
}

// 获取漏洞严重程度对应的文字颜色
const getVulnerabilitySeverityTextColor = (severity) => {
  const colors = {
    high: 'text-red-400',
    medium: 'text-yellow-400',
    low: 'text-blue-400'
  }
  return colors[severity] || 'text-gray-400'
}

// 从 localStorage 加载分析结果
onMounted(() => {
  const results = localStorage.getItem('analysisResults')
  if (results) {
    try {
      const parsedResults = JSON.parse(results)
      if (parsedResults.results && parsedResults.results.security && parsedResults.results.security.statistics) {
        // 使用防御性编程确保统计数据结构完整
        statistics.value = {
          total: parsedResults.results.security.statistics.total || 0,
          high: parsedResults.results.security.statistics.high || 0,
          medium: parsedResults.results.security.statistics.medium || 0,
          low: parsedResults.results.security.statistics.low || 0
        }
        vulnerabilities.value = parsedResults.results.security.vulnerabilities || []
      } else if (parsedResults.security && parsedResults.security.statistics) {
        // 兼容旧格式并使用防御性编程
        statistics.value = {
          total: parsedResults.security.statistics.total || 0,
          high: parsedResults.security.statistics.high || 0,
          medium: parsedResults.security.statistics.medium || 0,
          low: parsedResults.security.statistics.low || 0
        }
        vulnerabilities.value = parsedResults.security.vulnerabilities || []
      } else {
        console.warn('安全漏洞数据格式不符合预期')
      }
    } catch (error) {
      console.error('解析安全漏洞数据失败:', error)
    }
  }
})
</script> 